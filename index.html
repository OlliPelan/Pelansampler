<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Pelan Sampler v1.3.2</title>

<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body { 
    margin:0; padding:10px; background:#1f1f1f; color:#fff; 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
    user-select:none; -webkit-user-select:none;
    touch-action: manipulation;
    padding-top: max(10px, env(safe-area-inset-top));
    padding-bottom: max(10px, env(safe-area-inset-bottom));
    padding-left: max(10px, env(safe-area-inset-left));
    padding-right: max(10px, env(safe-area-inset-right));
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
    height: 100vh; height: 100dvh;
  }

  button { 
    padding:10px 14px; border:none; border-radius:8px; font-weight:700; 
    cursor:pointer; margin:4px; color:#fff; background:#444;
    -webkit-appearance: none; font-size: 16px;
  }
  #recordBtn { background:#e74c3c; }
  #loadBtn { background:#27ae60; }
  .clear-btn { background:#c0392b; }
  .copy-btn { background:#16a085; }
  .copy-btn:active { background:#1abc9c; }
  #muteGroup1Btn { background:#9b59b6; }
  #muteGroup1Btn.active { background:#e74c3c; }
  #muteGroup2Btn { background:#3498db; }
  #muteGroup2Btn.active { background:#00d1ff; }
  #muteGroup3Btn { background:#f39c12; }
  #muteGroup3Btn.active { background:#f1c40f; color:#333; }

  .pad-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-bottom:14px; }
  .pad {
    aspect-ratio:1; min-height:100px; background:#4d4d4d; border:2px solid #3b3b3b; border-radius:12px;
    display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition: transform .06s ease; position: relative;
  }
  .pad:active { transform: scale(0.98); }
  .pad.active { background:#e67e22; }
  .pad.has-sample { background:#2e9b60; }
  .pad.selected { border-color:#f1c40f; }
  .pad.muted1::before { content:'M1'; position:absolute; top:4px; left:6px; font-size:9px; font-weight:bold; color:#ff6b6b; background:#333; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; }
  .pad.muted2::before { content:'M2'; position:absolute; top:4px; left:6px; font-size:9px; font-weight:bold; color:#00d1ff; background:#333; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; }
  .pad.muted3::before { content:'M3'; position:absolute; top:4px; left:28px; font-size:9px; font-weight:bold; color:#f1c40f; background:#333; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; }
  .pad-number { font-weight:800; font-size:18px; }
  .pad-name { font-size:12px; margin-top:4px; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; max-width:90%; }

  .controls { background:#2b2b2b; padding:10px; border-radius:10px; margin-top:8px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .group { display:flex; align-items:center; gap:8px; flex:1 1 180px; }
  .group label { width:86px; font-size:13px; color:#ddd; }
  .group input[type=range] { flex:1; -webkit-appearance: none; height: 6px; border-radius: 3px; background: #555; }
  .group input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #f1c40f; cursor: pointer; }
  .group span { width:48px; text-align:right; font-size:12px; opacity:.85; }

  #status { margin-top:8px; font-size:14px; opacity:.9; }
</style>
</head>
<body>
  <div id="versionLabel">Pelan Sampler v1.3.2</div>

  <div class="pad-grid" id="padGrid"></div>

  <div>
    <button id="recordBtn">Record</button>
    <input type="file" id="fileInput" accept="audio/*" style="display:none;">
    <button id="loadBtn">Load</button>
    <button id="copyPad" class="copy-btn">Copy</button>
    <button id="clearPad" class="clear-btn">Clear</button>
    <button id="muteGroup1Btn">Mute 1</button>
    <button id="muteGroup2Btn">Mute 2</button>
    <button id="muteGroup3Btn">Mute 3</button>
  </div>

  <div class="controls">
    <!-- same sliders as before (master vol, pad vol, pitch, stretch, etc.) -->
    <!-- ... unchanged UI controls code ... -->
  </div>

  <div id="status">Ready</div>

<script>
class Sampler {
  constructor(){
    this.ctx=new (window.AudioContext||window.webkitAudioContext)();
    this.masterIn=this.ctx.createGain();
    this.masterGain=this.ctx.createGain();
    this.masterIn.connect(this.masterGain);
    this.masterGain.connect(this.ctx.destination);
    this.masterGain.gain.value=0.8;

    this.pads={}; this.sel=null; this.count=9;
    this.recorder=null; this.chunks=[]; this.isRecording=false;

    this.ui={
      grid:document.getElementById('padGrid'),
      file:document.getElementById('fileInput'),
      load:document.getElementById('loadBtn'),
      clear:document.getElementById('clearPad'),
      copy:document.getElementById('copyPad'),
      rec:document.getElementById('recordBtn'),
      status:document.getElementById('status'),
      muteGroup1:document.getElementById('muteGroup1Btn'),
      muteGroup2:document.getElementById('muteGroup2Btn'),
      muteGroup3:document.getElementById('muteGroup3Btn'),
      mVol:document.getElementById('masterVol'), mVolVal:document.getElementById('masterVolVal'),
      vol:document.getElementById('padVol'), volVal:document.getElementById('padVolVal'),
      pitch:document.getElementById('padPitch'), pitchVal:document.getElementById('padPitchVal'),
      start:document.getElementById('padStart'), startVal:document.getElementById('padStartVal'),
      end:document.getElementById('padEnd'), endVal:document.getElementById('padEndVal'),
      timeStretch:document.getElementById('timeStretch'), timeStretchVal:document.getElementById('timeStretchVal'),
      filter:document.getElementById('filter'), filterVal:document.getElementById('filterVal')
    };

    this.makePads();
    this.bind();
  }

  makePads(){
    for(let i=1;i<=this.count;i++){
      const d=document.createElement('div');
      d.className='pad'; d.dataset.id=i;
      d.innerHTML=`<div class="pad-number">${i}</div><div class="pad-name">Pad ${i}</div>`;
      this.ui.grid.appendChild(d);
      this.pads[i]={id:i, name:`Pad ${i}`, buf:null, vol:.85, pitch:1, start:0, end:1, timeStretch:1, filter:50, el:d};
    }
  }

  bind(){
    this.ui.grid.addEventListener('click',e=>{
      const d=e.target.closest('.pad'); if(!d) return;
      const id=+d.dataset.id; this.select(id); this.play(id);
    });

    this.ui.load.addEventListener('click',()=>this.ui.file.click());
    this.ui.file.addEventListener('change',e=>this.loadFile(e));
    this.ui.clear.addEventListener('click',()=>this.clear());
    this.ui.copy.addEventListener('click',()=>this.copyPad());
    this.ui.rec.addEventListener('click',()=>this.toggleRec());
  }

  copyPad(){
    if(!this.sel) return;
    const src=this.pads[this.sel];
    if(!src.buf){this.say("No sample to copy");return;}
    const target=this.findEmpty();
    if(!target){this.say("No empty pads available");return;}
    const p=this.pads[target];
    p.buf=src.buf; p.name="Copy of "+src.name;
    p.vol=src.vol; p.pitch=src.pitch; p.start=src.start; p.end=src.end;
    p.timeStretch=src.timeStretch; p.filter=src.filter;
    p.el.classList.add('has-sample');
    p.el.querySelector('.pad-name').textContent=p.name;
    this.say(`Copied Pad ${this.sel} → Pad ${target}`);
  }

  async toggleRec(){
    if(this.isRecording){this.stopRec();return;}
    if(this.sel && this.pads[this.sel].buf){this.say("Clear pad before recording");return;}
    const target=this.sel||this.findEmpty();
    if(!target){this.say("No empty pads");return;}
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      this.recorder=new MediaRecorder(stream); this.chunks=[];
      this.recorder.ondataavailable=e=>{if(e.data.size>0) this.chunks.push(e.data);};
      this.recorder.onstop=async()=>{
        const blob=new Blob(this.chunks,{type:this.recorder.mimeType});
        const ab=await blob.arrayBuffer(); const buf=await this.ctx.decodeAudioData(ab);
        const p=this.pads[target];
        p.buf=buf; p.name='Recorded Sample';
        p.el.classList.add('has-sample');
        p.el.querySelector('.pad-name').textContent=p.name;
        this.select(target); this.say('Recorded → Pad '+target);
        stream.getTracks().forEach(t=>t.stop());
      };
      this.recorder.start(); this.isRecording=true; this.say('Recording… tap Record again to stop');
    }catch(err){this.say("Mic error");}
  }
  stopRec(){if(this.recorder&&this.isRecording){this.recorder.stop();this.isRecording=false;}}
  findEmpty(){for(let i=1;i<=this.count;i++) if(!this.pads[i].buf) return i; return null;}
  say(m){this.ui.status.textContent=m;}
}
document.addEventListener('DOMContentLoaded',()=>new Sampler());
</script>
</body>
</html>